# SMPS

개인으로 프로젝트를 수행하였으며 전체적인 동작은 PWM IC인 TNY279PN의 PWM 발진신호로 초퍼 트랜스를 구동하여 2차측에 전달해 +5V,-5V,+40V가 출력되는 구성입니다. 아울러 안정적인 정전압을 유지하기 위한 피드백 신호는 포토커플러를 사용하여 구현하였습니다.

스위칭 IC : TNY279PN

포토커플러 : PC817

전압 래퍼런스 IC : TL431

수행기간 : 2021.11.01.~2022.01.30

# 제작한 SMPS 및 PCB 

![./result.jpg](./1.jpg)
![image](https://github.com/jinhoheoo/SMPS/assets/153490852/d1748533-69fa-4812-b305-584416baee55)
![image](https://github.com/jinhoheoo/SMPS/assets/153490852/f8c0981d-5c2f-426d-82c9-d54d7ddf9a5c)

<PI EXPERTS 출력 회로도>

![PI 로 나온 SMPS](https://github.com/jinhoheoo/SMPS/assets/153490852/4018d3d3-1790-47fe-93b2-b6f28212fc2e)


# SMPS 동작 영상

https://youtube.com/shorts/sAFXUCncAM8

# 세부사항 및 포트폴리오


![image](https://github.com/jinhoheoo/SMPS/assets/153490852/d05125e2-eac5-4da4-be80-1ce280ccb0e9)

![image](https://github.com/jinhoheoo/SMPS/assets/153490852/370092da-d5f7-4be6-b61b-524f4f5d29df)

![image](https://github.com/jinhoheoo/SMPS/assets/153490852/bd05c39d-a4fa-48d6-b977-5fb2b7b6e834)

## 부품 선정 과정

PI EXPERTS를 이용해 기본적인 플라이백 SMPS 회로도 산출하여 부품을 수정하여 회로도 완성하였음. 저전력이므로 FET가 내장된 스위칭IC 사용함. 전류측정기가 없어 제대로 DCM 즉 불연속모드로 작동하는지는 검증하지 못하였으나 출력측에 더미저항과 같이 부하전류를 높여 CCM 상태를 만드는 설계를 적용하지 않아 DCM으로 동작한다고 예상함.

1. 필터부

- 퓨즈는 돌입전류 제거용으로 최대 전류의 1.5배하여 정격전류 설정 (250/1A)

- 바리스터는 서지전압 제거용으로 인가 전압의 * 2배 이상으로함 220V의 경우 440V 굳이 쓰지 않고 470V 사용 (10D471)

- 써미스터는 ON/OFF 10만번 정도해서 콘덴서 망가지는지 확인하며 소자값 정한다하여 일반적으로 사용하는 크기 사용 (5D7)

2. 1차 정류부

- 브릿지 다이오드를 사용하였고 평활 커패시터의 경우 정격전압을 인가전압의 1.5배 정도인 커패시터를 선정하였고, 용량의 경우 적당히 큰 용량을 선택하여 충방전 속도에 속도를 늦춰 리플이 적은 DC전압을 만듬.

- LPF의 경우 ROHM의 문서를 참고하였으며, 해당 문서에서 인덕터 L은 10μH, C10은 10μF~100μF 정도를 기준선정하면 된다고 명시되어있어 이를 활용해 용량을 선정 후 커패시터의 정격전압만을 앞과 같이 고려함.

- 중간에 방전용 저항을 두어 커패시터에 충전된 전압을 방전시킴.   

3. 스위칭부

- 트랜스의 경우 PI EXPERTS에서 산출된 값을 활용해 강사님이 제작업체에 직접 요청하여 제작한 것을 받아 사용함.

- 트랜스와 병렬로 연결된 스너버 회로의 경우 ROHM의 문서를 참고하였고 문서에서 FET의 내압을 고려하였음. 스위칭 IC인 TNY279PN의 경우 700V내압인 것을 바탕으로 리플전압 크기 등을 모두 고려하여야 했지만 계측에 부족함으로 인해 추천하는 값인 저항은 100K로 커패시터 용량은 1000pF로 그리고 내압은 700의 1.5배인 1000V인 것을 선택하였음.  다이오드의 경우에도 내압이 충분히 큰걸 선정함. 패스트 리커버리 다이오드를 추천하였으나 해당 문서에서는 정류다이오드를 활용하여 정류다이오를 선택함.

- PI EXPERTS에서 나온 TNY279PN 스위칭 IC를 활용하여 타려식 전원회로를 구현함. 먼저 TNY279PN의 EN/UV 핀은 1.2V High 레벨 전압을 가지며,포토커플러 내장 BJT와 연결되어 BJT의 스위칭 동작을 감지함.
  EN/UV 핀에서 드라이브되는 전류량이 전류 제한량을 넘으면 MOSFET 스위칭을 아예 OFF시킴(포토커플러 BJT가 ON 되어, EN/UV 핀의 전압은 0.2V 수준 Low 레벨로 낮아짐).
  BP/M 핀은 연결된 바이패스 캐패시터의 용량에 따라 EN/UV 핀의 전류 제한량을 조절함. 전류 제한량이 낮을수록 트랜스 2차단의 전압 변화에 민감하게 반응하여,전압이 조금만 올라가도 스위칭 주파수를 낮추기 때문에 SMPS 전력이 그만큼 
  낮아짐. 반대로, 전류 제한량을 높이면 2차단의 전압 변화에 덜 민감하게 반응하여 보다 고전력 설계에 알맞음. 그리고 이 커패시터가 FET가 ON일 때 IC 동작에 필요한 전압을 공급하는 역할도 수행함.

- 1차측과 2차측 사이에 Y-커패시터로 플로팅 방지 기능을 구현함. 소자 선정은 ROHM 문서에서 제시한 2200pF/1KV로 선택하였음.

4. 2차 정류부

- 정류 다이오드의 경우 쇼트키 다이오드를 권장하였으나 정류 다이오드를 사용하는 대신 역방향 회복 시간 개선 회로인 스너버 회로를 달아 문제를 해결함.  Rohm에서 C는 500V 1000pF, R은 10Ω 1W 정도를 선택을 추천하여 저항은 100옴으로 증가시킨 대신 탄소저항을 쓰고 C는 5v짜리에 연결해 전압 낮으니 0.1uf 모노커패시터를 사용함.

- 2차측의 평활다이오드 및 LPF와 방전용 저항의 경우에도 1차측의 경우와 마찬가지로 선정하였음.

5. 피드백부

- 피드백 회로는 PI EXPERTS의 산출 회로드를 기본으로 하여 전압 레퍼런스 IC인 TL431의 부궤환을 이용하는 Vo=(1+R1/R2)*Vref 공식을 고려하여 5V의 정전압을 유지하는 회로를 설계함. 즉 TL431의 부궤환으로 2.5v가 ref에서 유지하려하는데 변동이 일어니면 캐스오드에 걸리는 Vo 전압이 달라지게 됨. 이에 따라 포토커플러 LED에 들어오는 전류가 달라지고 TR로 증폭되어 보내는 전류가 달라지니 스위칭 IC가 그걸 보고 PWM DUTY를 조절함.


![image](https://github.com/jinhoheoo/SMPS/assets/153490852/70924aea-a8ba-4e3d-94b6-91e5afc35a09)



## 동작원리

1. 교류(AC85V ∼ 265V)나 직류(DC80V ∼ 240V) 전압이 인가되면 바리스타로 서지를 막아주고 퓨즈와 서미스터(NTC)는 돌입전류에 의해서 콘덴서 C6가 소손 되는 것을 막아줍니다.
입력신호는 브릿지 다이오드를 거쳐 정류된 후 파이필터에 의해 평활되고 노이즈가 제거 되어 직류 전압이 됩니다.

2. TNY279 내부의 MOSFET이 132KHz로 스위칭 하는 펄스에 따라서 MOSFET가 ON/OFF 스위칭 동작을 하는데 이 때 FET가 ON시 트랜스의 1차측 권선에 전류가 흘러 에너지가 축적되고 FET가 OFF 될 시 축척된 에너지가 2차측 권선으로 출력됩니다. 트랜스와 병렬로 스너버 회로를 연결하여 트랜스로 인한 누설 인덕턴스가 FET의 스위칭에 의해 발생하는 서지를 스너버 회로로 막아줍니다.

3. MOSFET OFF상태일 때 2차로 넘어온 전압은 다이오드를 지나 정류되고 파이필터를 거쳐 평활되어 직류 전압(+40V, +5V, -5V)을 얻습니다. 이때 5V에 다이오드와 병렬연결 된 스너버 회로(다이오드 효율 개선용)는 다이오드 trr(역방향 회복 시간)을  짧게 줄여주는 역할과 ON/OFF시 발생되는 노이즈를 제거해줍니다. MOSFET ON 상태가 되면 2차측에 전압이 넘어오지 않아 파이필터의 C에 저장된 전압이 방전하여 전압을 유지시킵니다.

4. 안정적인 전압을 얻기 위해 포토커플러를 이용해 피드백 제어를 합니다. 기본적으로 무부하 상태에서는 포터커플러의 LED가 on 상태로 TR에 전류를 인가합니다. 그러나 증폭된 전류가 전류제한치 이하이므로 스위칭을 멈추는 동작은 없습니다. 오실로스코프를 통한 측정은 TL431의 경우 무부하시 캐스오드핀은 3.3V, ref핀은 2.5V가 출력되고 포토커플러에서 1.2V가 출력되어 안정적인 출력을 얻습니다.

5. 부하로 인한 변화과정은 먼저 부하의 증가로 인해 출력 전류가 증가하여 출력전압이 감소하게 됩니다. 그러면 TL431의 REF단자에 들어오는 전압이 감소하게 되어 TL431 내부의 opamp의 +핀 보다 작게되면 opamp의 출력은 증가하는 방향으로 동작하게 됩니다. 그러면 opamp와 연결된 내부 tr의 이미터 쪽 전압도 증가할 것입니다. 그 말은 결론적으로 캐스오드 전압이 조금 상승한다는 것을 의미합니다. 포토커플러의 LED는 on를 유지 할 것이고 이렇게 증가된 정전압을 이용해 전압을 유지시킵니다. 또한 스위칭 IC의 특성으로 발진 횟수가 증가해 높은 전압을 인가해 줍니다. 오실로스코프를 통한 측정은 TL431의 경우 캐스오드핀은 3.5V, ref핀은 2.6V가 출력되고 포토커플러에서 1.2V가 출력되어 안정적인 출력을 얻습니다.

6. 문제는 스위칭 증가로 인한 과전압이 발생했을 때 TL431의 opamp 출력은 낮아지는 방향으로 동작하고 그말은 캐스오드의 전압이 감소하게 됩니다. 그러면 포토커플러 LED에 흐르는 전류가 증가하게 되고 그말은 포토커플러의 TR에 더 많이 증폭된 전류가 인가되게 됩니다. 증폭된 전류가 BP/M핀의 커패시터로 결정된 전류제한치보다 크게되면 포토커플러의 TR이 ON이 되어 TNY279의 EN(UV)핀이 0.2V로 낮아져 LOW상태가 되므로 스위칭 동작을 중지합니다.

7. 이 상태가 유지되어 2차측 전압이 감소하여 LED로 가는 전류가 감소하고  OFF가 됩니다. 그러면 EN(UV)핀이 다시 HIGH가 되고 TNY279가 다시 정상적인 작동을 하게 되어 FET가 ON/OFF 스위칭으로 안정적인 전압을 얻습니다.

## 결과

1.사전 계획 문제로 인한 효율 문제
   
-> Flyback 방식 뿐만 아니라 모든 SMPS 회로의 효율 개선을 위하여서는 먼저 설계하려는 SMPS의 전력을 계획한 후 그에 맞게 트랜스 코어, 갭, 권선비, 권선비에 따른 감는 횟수, 권선 두께, 트랜스 1, 2차 인덕턴스 등을 고려한 트랜스 설계가 필요합니다. 이것을 뼈대로 하여 스위칭 소자에 걸리는 서지 전압과 스너버 회로 사이의 효율 손실 계산, 누설 인덕턴스로 인해 2차 다이오드에서 생기는 스위칭 노이즈 개선 등의 정량적 연구개발이 수행되어야 합니다. 또한 리플이 많은 Flyback 방식의 특성 상 리플을 고려한 평활 콘덴서 선정 및 적정 필터 사용이 과제입니다.
   
-> 그러나 첫째로 이번 프로토타입이 SMPS 연구개발의 첫 공부이자 첫 시도여서 위와 같은 설계를 모두 고려하기에는 무리가 있었고, 둘째로 220V 전력 공급원을 사용하며 스위칭 레귤레이터 사용으로 인해 열적 손실이 적으므로, 효율 개선보다는 일단 정성적 동작 및 안전성 위주의 설계를 진행하였습니다.

-> Flyback 방식은 트랜스 1차 코일에서 바로 2차 코일로 에너지를 전달하는 Forward converter 방식과는 달리 1차 코일에서 코어로 한번 저장된 에너지가 2차 코일로 넘어가므로 그에 따른 태생적 효율 저하가 있습니다. 또 이번 설계에서 사용한 TNY279PN Flyback IC는 듀티비보다는 스위칭 주파수를 최대 132 kHz까지 조정함으로써 전력을 전달하므로 스위칭 손실이 많아 SMPS 효율이 높지 않다. 실제로 TNY279PN 데이터시트에 명기된 효율은 75% 수준으로, 일반적인 SMPS 효율에 비해서 낮다. 311V의 DC 전압을 40V, 5V 수준의 저전압으로 전환시키는 것도 낮은 효율의 원인입니다. 이런 낮은 효율 문제 또한 정성적 설계의 이유입니다. 

2.고부하 측정시 출력저하

![image](https://github.com/jinhoheoo/SMPS/assets/153490852/7e3a3512-61c5-455e-889c-c62aa503e0dc)

-> 전체 소비전력인 21.8w에서 15.5w 만큼의 71% 효율을 가진 smps를 설계하려 하였으나  피드백이 구성된 부분은 풀로드인 5옴으로 했을 때 목표로하는 5v/1a가 측정되어 5w가 출력되었으나 40v/0.2a 인 8w 중에서  최대전력을 측정하기위해 풀로드인 200옴을 사용햇을 때 30v가 출력되었다 33의제곱/200인 5.5w가 출력되었습다. -5v/0.5a에서는 10옴으로 했을 때 -3.5v가 출력되었습니다. 이말은 1.2w이니 전체 5.5+5+1.2= 11.7w로 53%의 효율을 가진다는 말입니다. 거의 18%가 떨어진건데 이것은 5v에서는 원하는 출력이 피드백으로 유지되었으나 피드백회로가 없는 40v와 -5v에서는 원하는 출력을 이루지 못하였습니다.


-> 스위칭 레귤레이터에서 부하가 증가하면 IC는 스위칭 주파수를 높여서 전력 전달을 증가시키려고 합니다. 이는 출력 전압을 일정하게 유지하기 위한 조치입니다. 하지만, 풀로드인 고부하 상태에서 출력 전압이 감소하는 현상은 스위칭 주파수가 과도하게 높아져서 발생할 수 있습니다. 또한 트랜스의 특성 상 출력전류가 있을 때 트랜스 내부의 저항성분으로 인한 전력손실이 일어나 출력 전압이 감소하게 됩니다.

-> 이를 방지하기 위해 피드백 메커니즘이 중요한데, 이는 전류가 기준치를 초과할 때 스위칭을 일시적으로 멈추어 전류를 조절합니다. 피드백 없이 주파수가 증가하면 스위칭 노이즈와 관련된 전력 소모가 증가하고, 이는 부하 측의 전력 소모를 감소시켜 결과적으로 출력 전압과 전류를 낮추게 됩니다. 따라서, 피드백 메커니즘은 스위칭 레귤레이터의 성능을 최적화하는 데 중요한 역할을 합니다. 원하는 출력 목표를 달성하기 위해서는 사전 계획단계에서 IC의 특성을 꼼꼼하게 파악해 피드백 회로를 각각 구성할 필요성을 느꼈습니다.

-> 다만 풀로드가 아닌 풀로드에 근접한 부하를 연결하였을 때는 무부하와 마찬가지로 일정한 직류전압이 출력되었습니다. 그러나 풀로드에서는 피드백회로에서만 직류전압이 출력되고 그 외의 전원에서는 삼각파 형태로 출력되었습니다. -5v의 경우 -2v에서 부터 -4.4v까지 불안정한 전압이 출력되었습니다. 스위칭 IC의 드레인 핀을 측정한 결과 피드백 전원의 경우엔 무부하시 80kHz, 풀로드에 근접한 부하시 130kHz, 풀로드시 300kHz가 출력되며 풀로드 시 필요 전류가 많아져 더 많은 스위칭이 발생한다는 것을 알 수 있었습니다. 그 외의 전원의 경우에는 풀로드를 제외하고 동일하게 나왔는데 풀로드 시에는 일정한 주파수가 나오지 않아 제대로 측정하지 못했습니다. 이러한 결과가 풀로드시 출력전압의 삼각파 출력을 만들었다고 판단하였습니다.

3.노이즈와 노이즈 대책의 이해

-> 전원회로 특성 상 여러 노이즈 방지 부품이 필요합니다. 대부분의 노이즈는 인덕턴스와 커패시턴스로 인한 노이즈임을 파악해 전자회로와 회로이론의 수식들이 실무에서 어떻게 적용되는지 이해하였습니다.

-> 인덕턴스와 커패시턴스에 대한 이해를 바탕으로 전원에 퓨즈와 서미스터를 사용하여 돌입전류를 제한하고 바리스터를 이용해 서지 전압을 해결했습니다. 공통모드 노이즈와 차동모드 노이즈의 경우 라인필터와 X커패시터를 활용하여 해결하였고, 스위칭IC인 TNY279PN 내부의 MOSFET 스위칭으로 인해 발생하는 서지전압을 스너버회로로 해결했습니다.

## BOM

![image](https://github.com/jinhoheoo/SMPS/assets/153490852/eaefd9d5-5a04-4ba1-b012-366cded46aca)
![image](https://github.com/jinhoheoo/SMPS/assets/153490852/c8c41eae-2521-427e-af90-43c8e175160d)

## 원가 분석표

![image](https://github.com/jinhoheoo/SMPS/assets/153490852/25c7f08f-c440-4f16-b0e9-0dbae596ffbe)
![image](https://github.com/jinhoheoo/SMPS/assets/153490852/ee561783-e869-4f5c-90e7-eb80cb6ba941)
![image](https://github.com/jinhoheoo/SMPS/assets/153490852/8b4f7456-fa9e-4da9-8e74-1a9f2628ac46)



